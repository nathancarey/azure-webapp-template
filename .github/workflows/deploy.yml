name: Deploy to Azure

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      appName:
        description: 'Application name (must be globally unique)'
        required: true
        type: string
      sku:
        description: 'App Service Plan SKU'
        required: false
        default: 'B1'
        type: choice
        options:
          - F1
          - B1
          - B2
          - S1
          - P1v2
      enableAppInsights:
        description: 'Enable Application Insights'
        required: false
        default: true
        type: boolean
      enableKeyVault:
        description: 'Enable Key Vault'
        required: false
        default: true
        type: boolean

  # Auto-deploy on push to main (optional - comment out if not needed)
  # push:
  #   branches: [main]
  #   paths:
  #     - 'templates/**'

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  TEMPLATE_FILE: templates/azuredeploy.json
  PARAMETERS_FILE: templates/azuredeploy.parameters.json

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "deployment_name=deploy-$TIMESTAMP" >> $GITHUB_OUTPUT

          # Use input or generate unique name
          if [ -n "${{ inputs.appName }}" ]; then
            echo "app_name=${{ inputs.appName }}" >> $GITHUB_OUTPUT
          else
            echo "app_name=app-${{ github.run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group (if needed)
        run: |
          RG="${{ secrets.AZURE_RG }}"
          LOCATION="${{ secrets.AZURE_LOCATION || 'eastus' }}"

          if ! az group show --name "$RG" &>/dev/null; then
            echo "Creating resource group: $RG in $LOCATION"
            az group create --name "$RG" --location "$LOCATION"
          else
            echo "Resource group already exists: $RG"
          fi

      - name: What-If Analysis
        id: whatif
        run: |
          echo "Running What-If analysis..."
          az deployment group what-if \
            --resource-group ${{ secrets.AZURE_RG }} \
            --template-file ${{ env.TEMPLATE_FILE }} \
            --parameters appName=${{ steps.vars.outputs.app_name }} \
            --parameters sku=${{ inputs.sku || 'B1' }} \
            --parameters enableApplicationInsights=${{ inputs.enableAppInsights || true }} \
            --parameters enableKeyVault=${{ inputs.enableKeyVault || true }} \
            --result-format FullResourcePayloads \
            | tee whatif-output.txt

          # Count changes
          CREATES=$(grep -c "Create" whatif-output.txt || echo "0")
          MODIFIES=$(grep -c "Modify" whatif-output.txt || echo "0")
          DELETES=$(grep -c "Delete" whatif-output.txt || echo "0")

          echo "creates=$CREATES" >> $GITHUB_OUTPUT
          echo "modifies=$MODIFIES" >> $GITHUB_OUTPUT
          echo "deletes=$DELETES" >> $GITHUB_OUTPUT

      - name: Deploy ARM Template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ${{ env.TEMPLATE_FILE }}
          deploymentName: ${{ steps.vars.outputs.deployment_name }}
          parameters: >
            appName=${{ steps.vars.outputs.app_name }}
            sku=${{ inputs.sku || 'B1' }}
            enableApplicationInsights=${{ inputs.enableAppInsights || true }}
            enableKeyVault=${{ inputs.enableKeyVault || true }}
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT="${{ steps.vars.outputs.deployment_name }}"
          RG="${{ secrets.AZURE_RG }}"

          # Get outputs
          WEB_APP_URL=$(az deployment group show \
            --name "$DEPLOYMENT" \
            --resource-group "$RG" \
            --query 'properties.outputs.webAppUrl.value' -o tsv)

          WEB_APP_NAME=$(az deployment group show \
            --name "$DEPLOYMENT" \
            --resource-group "$RG" \
            --query 'properties.outputs.webAppName.value' -o tsv)

          KEY_VAULT_NAME=$(az deployment group show \
            --name "$DEPLOYMENT" \
            --resource-group "$RG" \
            --query 'properties.outputs.keyVaultName.value' -o tsv 2>/dev/null || echo "")

          echo "web_app_url=$WEB_APP_URL" >> $GITHUB_OUTPUT
          echo "web_app_name=$WEB_APP_NAME" >> $GITHUB_OUTPUT
          echo "key_vault_name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          WEB_APP="${{ steps.outputs.outputs.web_app_name }}"
          RG="${{ secrets.AZURE_RG }}"

          # Check web app state
          STATE=$(az webapp show --name "$WEB_APP" --resource-group "$RG" --query 'state' -o tsv)
          echo "Web App State: $STATE"

          if [ "$STATE" != "Running" ]; then
            echo "Warning: Web App is not in Running state"
          fi

          # Check if site is responding (may take a moment)
          URL="${{ steps.outputs.outputs.web_app_url }}"
          echo "Checking URL: $URL"

          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 500 ]; then
              echo "âœ“ Site responding with status: $STATUS"
              break
            fi
            echo "Attempt $i: Status $STATUS, waiting..."
            sleep 10
          done

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment** | ${{ steps.vars.outputs.deployment_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Group** | ${{ secrets.AZURE_RG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Web App** | ${{ steps.outputs.outputs.web_app_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.outputs.outputs.web_app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Key Vault** | ${{ steps.outputs.outputs.key_vault_name || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Applied" >> $GITHUB_STEP_SUMMARY
          echo "- Creates: ${{ steps.whatif.outputs.creates }}" >> $GITHUB_STEP_SUMMARY
          echo "- Modifies: ${{ steps.whatif.outputs.modifies }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deletes: ${{ steps.whatif.outputs.deletes }}" >> $GITHUB_STEP_SUMMARY

      - name: Output URLs
        run: |
          echo ""
          echo "=========================================="
          echo "  DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo ""
          echo "Web App URL: ${{ steps.outputs.outputs.web_app_url }}"
          echo ""
          if [ -n "${{ steps.outputs.outputs.key_vault_name }}" ]; then
            echo "Key Vault: https://${{ steps.outputs.outputs.key_vault_name }}.vault.azure.net/"
          fi
          echo ""
